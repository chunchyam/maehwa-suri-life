<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>평생대운 계산</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h1, h2 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
    }
    select, input[type="number"] {
      padding: 5px;
      font-size: 1em;
      margin-right: 10px;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      background: #007BFF;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    table {
      margin-top: 20px;
      border-collapse: collapse;
      width: 100%;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 10px;
      text-align: center;
      vertical-align: middle;
    }
    .formula {
      font-size: 0.9em;
      color: #666;
    }
    .value {
      font-size: 1.2em;
      font-weight: bold;
      color: #333;
    }
    .small-text {
      font-size: 0.9em;
      color: #555;
      margin-top: 5px;
    }
    .output {
      margin-top: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #f5f5f5;
      white-space: pre-wrap;
      font-size: 1.1em;
      line-height: 1.4em;
    }
    /* 하이라이트 색상 */
    .highlight-blue {
      background-color: lightblue !important;
    }
    .highlight-red {
      background-color: lightcoral !important;
    }
    .highlight-purple {
      background-color: violet !important;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>평생대운 계산</h1>
  
  <!-- 선택 입력란 -->
  <label>출생년도 천간 (갑=1, 을=2, …, 계=10):</label>
  <select id="cheongan">
    <option value="1">갑(1)</option>
    <option value="2">을(2)</option>
    <option value="3">병(3)</option>
    <option value="4">정(4)</option>
    <option value="5">무(5)</option>
    <option value="6">기(6)</option>
    <option value="7">경(7)</option>
    <option value="8">신(8)</option>
    <option value="9">임(9)</option>
    <option value="1">계(1)</option>
  </select>
  
  <label>출생년도 지지 (자=1, 축=2, …, 해=12):</label>
  <select id="yearZhi">
    <option value="1">자(1)</option>
    <option value="2">축(2)</option>
    <option value="3">인(3)</option>
    <option value="4">묘(4)</option>
    <option value="5">진(5)</option>
    <option value="6">사(6)</option>
    <option value="7">오(7)</option>
    <option value="8">미(8)</option>
    <option value="9">신(9)</option>
    <option value="1">유(1)</option>
    <option value="2">술(2)</option>
    <option value="3">해(3)</option>
  </select>
  
  <label>음력 생월 (숫자 입력):</label>
  <input type="number" id="monthZhi" min="1" max="12" value="3">
  
  <label>음력 생일 (숫자 입력):</label>
  <input type="number" id="dayZhi" min="1" max="31" value="25">
  
  <label>생시 지지 (자=1, 축=2, …, 해=12):</label>
  <select id="timeZhi">
    <option value="1">자(1)</option>
    <option value="2">축(2)</option>
    <option value="3">인(3)</option>
    <option value="4">묘(4)</option>
    <option value="5">진(5)</option>
    <option value="6">사(6)</option>
    <option value="7">오(7)</option>
    <option value="8">미(8)</option>
    <option value="9">신(9)</option>
    <option value="1">유(1)</option>
    <option value="2">술(2)</option>
    <option value="3">해(3)</option>
  </select>
  
  <hr>
  
  <!-- 평생수리(1번)는 사용자가 직접 입력 -->
  <label>평생수리 (1번):</label>
  <input type="number" id="pSuri" min="1" max="9" value="3">
  
  <button onclick="calculateTable()">표 생성하기</button>
  
  <div id="resultArea"></div>
  
  <hr>
  
  <!-- 선택 하이라이트 영역 -->
  <h2>일지 선택</h2>
  <label for="zodiacSelect">일지 선택:</label>
  <select id="zodiacSelect">
    <option value="인">인</option>
    <option value="묘">묘</option>
    <option value="진">진</option>
    <option value="사">사</option>
    <option value="오">오</option>
    <option value="미">미</option>
    <option value="신">신</option>
    <option value="유">유</option>
    <option value="술">술</option>
    <option value="해">해</option>
    <option value="자">자</option>
    <option value="축">축</option>
  </select>
  <button onclick="highlightCombos()">하이라이트 적용</button>
  
  <div id="logOutput" class="output"></div>
  
  <!-- "수리별 운세 보기" 버튼 (새 창 열기) -->
  <button onclick="openFortuneWindow()">수리별 운세 보기</button>
</div>

<script>
  // --------------------------
  // 전역 변수: 12지 배열 (표 레이블 순서: index 기준)
  // --------------------------
  const monthLetters = ["인", "묘", "진", "사", "오", "미", "신", "유", "술", "해", "자", "축"];
  
  // --------------------------
  // mod9 함수: n을 9로 나눈 나머지가 0이면 9를 반환 (결과는 1~9)
  // --------------------------
  function mod9(n) {
    const r = n % 9;
    return r === 0 ? 9 : r;
  }
  
  // --------------------------
  // 평생대운(2번) 계산: (천간 + 출생년도 지지 + 음력 생월 + 음력 생일 + 생시 지지)를 mod9 적용하여 구함
  // --------------------------
  function getDaeyun() {
    const cVal = parseInt(document.getElementById("cheongan").value);
    const yVal = parseInt(document.getElementById("yearZhi").value);
    const mVal = parseInt(document.getElementById("monthZhi").value);
    const dVal = parseInt(document.getElementById("dayZhi").value);
    const tVal = parseInt(document.getElementById("timeZhi").value);
    const sum = cVal + yVal + mVal + dVal + tVal;
    return mod9(sum);
  }
  
  // --------------------------
  // 표 생성 함수  
  // 공식:
  // 1번 = 평생수리 (사용자 입력)
  // 2번 = 평생대운 = getDaeyun() (mod9)
  // 3 = 1+2; 4 = 1+3; 5 = 2+3; 6 = 4+5;
  // 7 = 4+6; 8 = 5+6; 9 = 7+8;
  // 10 = 1+4+7; 11 = 2+5+8; 12 = 10+11;
  // 각 단계마다 mod9를 적용하여 1~9 값으로 처리
  function calculateTable(){
    const suri = mod9(parseInt(document.getElementById("pSuri").value));  // 평생수리(1번)
    const daeyun = mod9(getDaeyun());                                    // 평생대운(2번)
    
    const v3  = mod9(suri + daeyun);           // 3 = 1+2
    const v4  = mod9(suri + v3);               // 4 = 1+3
    const v5  = mod9(daeyun + v3);             // 5 = 2+3
    const v6  = mod9(v4 + v5);                 // 6 = 4+5
    const v7  = mod9(v4 + v6);                 // 7 = 4+6
    const v8  = mod9(v5 + v6);                 // 8 = 5+6
    const v9  = mod9(v7 + v8);                 // 9 = 7+8
    const v10 = mod9(suri + v4 + v7);          // 10 = 1+4+7
    const v11 = mod9(daeyun + v5 + v8);        // 11 = 2+5+8
    const v12 = mod9(v10 + v11);               // 12 = 10+11
    
    const resultValues = [suri, daeyun, v3, v4, v5, v6, v7, v8, v9, v10, v11, v12];
    
    // labelTable는 기존 "매화역수 수정본"의 수식 레이블 유지
    const labelTable = [
      ["인", "묘", "진"],
      ["사", "오", "미"],
      ["신", "유", "술"],
      ["해", "자", "축"]
    ];
    
    let html = '<h2>계산 결과</h2><table>';
    let rowKeys = [];
    let idx = 0;
    // 전체 연속 번호를 위해 전역 counter 선언 (모든 셀에 대해 연속적으로 번호 부여)
    let counter = 1;
    for (let row = 0; row < 4; row++) {
      html += '<tr>';
      let currentKey = "";
      for (let col = 0; col < 3; col++) {
        const label = labelTable[row][col];
        const val = resultValues[idx];
        // 동적 레이블: val 개의 연속된 번호 범위 생성 (예: val=3 → "1~3")
        let startVal = counter;
        let endVal = counter + val - 1;
        let dynLabel = (val === 1) ? String(startVal) : startVal + "~" + endVal;
        counter = endVal + 1;
        html += `<td id="cell-${idx}">
                  <div class="formula">${label}</div>
                  <div class="value">${val}</div>
                  <div class="small-text">${dynLabel}</div>
                 </td>`;
        currentKey += String(val);
        idx++;
      }
      rowKeys.push(currentKey);
      html += '</tr>';
      html += `<tr><td colspan="3" id="dynamic-label-row-${row}"></td></tr>`;
    }
    html += '</table>';
    
    document.getElementById("resultArea").innerHTML = html;
    
    // 동적 레이블을 각 행의 빈 영역에 삽입 (이미 각 셀에 동적 레이블은 같이 표시되지만)
    // 만약 별도의 조합 레이블이 필요하면 여기서 추가 처리 가능
  }
  
  // --------------------------
  // 하이라이트 적용 함수  
  // 해당 함수는, "일지 선택" 드롭다운에서 선택한 글자에 따라,
  // combosTable에 등록된 조합 문자열 내 해당 글자가 포함된 경우, 
  // 표의 해당 셀(각 셀 id="cell-번호")에 색을 입힙니다.
  function highlightCombos() {
    if (!document.getElementById("cell-0")) {
      alert("먼저 '표 생성하기' 버튼을 눌러 결과표를 생성해 주세요.");
      return;
    }
    
    // 모든 셀의 하이라이트 제거
    for (let i = 0; i < 12; i++) {
      const cell = document.getElementById("cell-" + i);
      if (cell) {
        cell.classList.remove("highlight-blue", "highlight-red", "highlight-purple");
      }
    }
    
    const selected = document.getElementById("zodiacSelect").value;
    let logMsg = `선택 글자 [${selected}] 관련 조합:\n`;
    const exceptions = ["진진", "오오", "유유", "해해"];
    
    // 컬러 분류 객체
    const colColor = {
      "암합": "blue", "육합": "blue", "꼭지합": "blue", "삼합": "blue", "방합": "blue",
      "형살": "red", "상충": "red", "귀문": "red"
    };
    
    // 조합 테이블: 각 열 이름과 조합 문자열들을 등록 (예시)
    const combosTable = {
      "암합":  ["자사", "오해", "인해"],
      "육합":  ["자축", "인해", "묘술", "진묘", "사신", "오미"],
      "꼭지합": ["진사", "축인", "술해", "신미"],
      "삼합":  ["인오술", "신자진", "해묘미", "사유축", "인오술"],
      "방합":  ["인묘진", "사오미", "신유술", "해자축"],
      "형살":  ["인사신", "축술미", "자묘", "진진", "오오", "유유", "해해"],
      "상충":  ["자오", "묘유", "사해", "인신", "진술"],
      "귀문":  ["자유", "축오", "인미", "묘신", "진해", "사술"]
    };
    
    // 분해 함수: 조합 문자열을 각 글자로 분리 (예: "사오미" → ["사", "오", "미"])
    function splitCombo(str) {
      return str.split("");
    }
    
    // combosTable을 순회하여, 선택한 글자가 포함된 조합이 있으면,
    // 해당 조합에 포함된 다른 글자에 대해 표의 셀에 색상을 적용.
    for (const colName in combosTable) {
      const comboArr = combosTable[colName];
      comboArr.forEach(function(comboStr) {
        const letters = splitCombo(comboStr);
        if (letters.includes(selected)) {
          const baseHighlightClass = exceptions.includes(comboStr)
            ? "highlight-red"
            : (colColor[colName] === "blue" ? "highlight-blue" : "highlight-red");
          
          letters.forEach(function(letter) {
            // 예외 조합에서는 선택한 글자 자체는 제외함
            if (!exceptions.includes(comboStr) && letter === selected) return;
            const idx = monthLetters.indexOf(letter);
            if (idx >= 0) {
              const cell = document.getElementById("cell-" + idx);
              if (cell) {
                const hasBlue = cell.classList.contains("highlight-blue");
                const hasRed = cell.classList.contains("highlight-red");
                if ((hasBlue && baseHighlightClass === "highlight-red") ||
                    (hasRed && baseHighlightClass === "highlight-blue")) {
                  cell.classList.remove("highlight-blue", "highlight-red");
                  cell.classList.add("highlight-purple");
                } else {
                  cell.classList.add(baseHighlightClass);
                }
              }
            }
          });
          const colorLabel = baseHighlightClass === "highlight-blue" ? "파랑" :
                             baseHighlightClass === "highlight-red" ? "빨강" : "보라";
          const filteredLetters = letters.filter(function(l) {
            return exceptions.includes(comboStr) ? true : l !== selected;
          });
          logMsg += `- [${colName}] "${comboStr}" → ${filteredLetters.join(",")} (→ ${colorLabel})\n`;
        }
      });
    }
    
    document.getElementById("logOutput").innerText = logMsg.trim();
  }
  
  // --------------------------
  // "수리별 운세 보기" 버튼: 새 창 열기
  function openFortuneWindow() {
    const fortuneHTML = `
      <!DOCTYPE html>
      <html lang="ko">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>수리별 운세</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; color: #333; }
          h1 { text-align: center; }
          table { width: 100%; border-collapse: collapse; margin-top: 20px; }
          th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: middle; }
          th { background: #007BFF; color: #fff; }
        </style>
      </head>
      <body>
        <h1>수리별 운세</h1>
        <table>
          <tr>
            <th>수리</th>
            <th>구분</th>
            <th>내용</th>
          </tr>
          <tr>
            <td rowspan="2">1수리</td>
            <td>합(삼합,육합)</td>
            <td>새로운 사람과 일이 나타남, 시작함</td>
          </tr>
          <tr>
            <td>형충파해원진</td>
            <td>원수, 배신자, 새로운 일 때문에 돈과 건강에 문제</td>
          </tr>
          <!-- 필요시 나머지 수리 운세 추가 -->
        </table>
      </body>
      </html>
    `;
    
    const newWindow = window.open("", "_blank");
    newWindow.document.open();
    newWindow.document.write(fortuneHTML);
    newWindow.document.close();
  }
</script>
</body>
</html>
